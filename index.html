<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת שירות לתושב – אבטיפוס HTML</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--bg:#0b0c0f;--card:#111318;--muted:#6b7280;--text:#e5e7eb;--brand:#4f46e5;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--border:#232633}
    html{font-family:system-ui,-apple-system,Segoe UI,Roboto,Heebo,Arial,sans-serif;}
    body{margin:0;background:#0b0c0f;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,12,15,.7);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    nav{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:var(--card);padding:10px 14px;border-radius:12px;cursor:pointer}
    .tab[aria-selected="true"]{outline:2px solid var(--brand)}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}

    main{padding:24px 16px}
    section{display:none}
    section.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:720px){.grid.cols-2{grid-template-columns:1fr}}

    label{font-size:.95rem}
    input, textarea, select{width:100%;background:#0b0c0f;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted);font-size:.9rem}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,#2a2f45,#1a1f35);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#5b5ee6,#4a4dd8);}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#15803d)}
    .btn.bad{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0d0f16}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:right}
    th{color:#cbd5e1}
    tr:hover td{background:#0d1020}

    .status{font-weight:600}
    .s-new{color:#93c5fd}
    .s-triaged{color:#a5b4fc}
    .s-in_progress{color:#34d399}
    .s-pending_citizen{color:#fbbf24}
    .s-ready_for_close{color:#22c55e}
    .s-closed{color:#94a3b8;text-decoration:line-through}
    .s-reopened{color:#f87171}

    .flex{display:flex;gap:12px;align-items:center}
    .space-between{justify-content:space-between}
    .w-100{width:100%}

    .toast{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none}
    .toast .msg{pointer-events:auto; background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px}

    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b0c0f;border:1px solid var(--border);border-bottom-width:3px;border-radius:8px;padding:2px 6px}

    .badge{border:1px solid var(--border);padding:3px 6px;border-radius:8px;color:#e2e8f0}
    .badge.ok{border-color:#16a34a;color:#86efac}
    .badge.warn{border-color:#f59e0b;color:#fcd34d}
    .badge.bad{border-color:#ef4444;color:#fca5a5}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="brand" aria-label="מערכת שירות לתושב">
          <span class="dot" aria-hidden="true"></span>
          <strong>שירות לתושב</strong>
          <span class="muted">— אבטיפוס HTML (MVP)</span>
        </div>
        <div class="tabs" role="tablist" aria-label="ניווט מסכים">
          <button class="tab" role="tab" aria-controls="screen-intake" aria-selected="true" data-screen="intake">פתיחת פנייה</button>
          <button class="tab" role="tab" aria-controls="screen-status" aria-selected="false" data-screen="status">בדיקת סטטוס</button>
          <button class="tab" role="tab" aria-controls="screen-admin" aria-selected="false" data-screen="admin">אדמין</button>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- מסך פתיחת פנייה -->
    <section id="screen-intake" class="active" aria-labelledby="tab-intake">
      <div class="card grid" aria-live="polite">
        <h2>טופס פתיחת פנייה</h2>
        <p class="muted">מלאו את הפרטים, צרפו קבצים (תמונה/מסמך) ושלחו. נקצה מספר פנייה וננתב למחלקה המתאימה באופן אוטומטי.</p>
        <form id="form-intake" class="grid cols-2" novalidate>

          <div>
            <label for="firstName">שם פרטי</label>
            <input id="firstName" name="firstName" required minlength="2" autocomplete="given-name" />
          </div>
          <div>
            <label for="lastName">שם משפחה</label>
            <input id="lastName" name="lastName" required minlength="2" autocomplete="family-name" />
          </div>

          <div>
            <label for="phone">טלפון נייד</label>
            <input id="phone" name="phone" required pattern="^\\+?[0-9]{9,15}$" placeholder="0501234567" inputmode="tel" />
            <small class="muted">נדרש לקוד אימות עתידי ולקבלת עדכונים</small>
          </div>
          <div>
            <label for="email">דוא"ל</label>
            <input id="email" name="email" type="email" required placeholder="name@example.com" autocomplete="email" />
          </div>

          <div class="w-100">
            <label for="address">כתובת (עיר/רחוב/מס׳)</label>
            <input id="address" name="address" required placeholder="הרצל 10, רחובות" autocomplete="street-address" />
          </div>

          <div>
            <label for="subject">נושא קצר</label>
            <input id="subject" name="subject" maxlength="100" required placeholder="לדוגמה: בור בכביש מול הבית" />
          </div>

          <div class="w-100">
            <label for="description">תיאור חופשי</label>
            <textarea id="description" name="description" required placeholder="פרטו בקצרה את הבעיה או הבקשה"></textarea>
          </div>

          <fieldset class="w-100" aria-describedby="uploadHelp">
            <legend>צירוף קבצים</legend>
            <input id="files" name="files" type="file" accept="image/*,.pdf,.doc,.docx,.mp4" multiple />
            <div id="uploadHelp" class="muted">מקס׳ 10 קבצים, עד 15MB לקובץ. סריקה אנטי-וירוס בצד שרת (בפרודקשן).</div>
            <div id="fileList" class="muted"></div>
          </fieldset>

          <div class="row">
            <input type="checkbox" id="consentEmail" name="consentEmail" />
            <label for="consentEmail">אני מסכים/ה לקבל עדכונים בדוא"ל</label>
          </div>
          <div class="row">
            <input type="checkbox" id="consentWhatsApp" name="consentWhatsApp" />
            <label for="consentWhatsApp">אני מסכים/ה לקבל עדכונים בוואטסאפ</label>
          </div>
          <div class="row">
            <input type="checkbox" id="consentPrivacy" name="consentPrivacy" required />
            <label for="consentPrivacy">מאשר/ת את מדיניות הפרטיות ותנאי השימוש</label>
          </div>

          <div class="flex space-between w-100" style="margin-top:8px">
            <div class="muted">טיפ: ניתן לחזור למסך <span class="kbd">בדיקת סטטוס</span> באמצעות מספר הפנייה.</div>
            <button class="btn primary" type="submit">שליחת פנייה</button>
          </div>
        </form>
      </div>

      <div id="receipt" class="card" hidden>
        <h3>קיבלנו! ✅</h3>
        <p>מספר פנייה: <strong id="ticketNumber"></strong></p>
        <p>הפנייה נשלחה למחלקה: <strong id="ticketDept"></strong></p>
        <div class="row">
          <button class="btn" id="btnGoStatus">בדיקת סטטוס</button>
          <button class="btn ghost" id="btnNew">פתיחת פנייה נוספת</button>
        </div>
      </div>
    </section>

    <!-- מסך סטטוס -->
    <section id="screen-status" aria-labelledby="tab-status">
      <div class="card grid">
        <h2>בדיקת סטטוס פנייה</h2>
        <form id="form-status" class="grid cols-2">
          <div>
            <label for="status-ticket-id">מספר פנייה</label>
            <input id="status-ticket-id" required placeholder="למשל: T-2025-000123" />
          </div>
          <div>
            <label for="status-contact">דוא"ל או טלפון</label>
            <input id="status-contact" required placeholder="אימות זהות מהיר" />
          </div>
          <div class="flex space-between w-100" style="margin-top:8px">
            <span class="muted">איננו שומרים סיסמאות – אימות מבוסס פרט התקשרות.</span>
            <button class="btn" type="submit">בדוק</button>
          </div>
        </form>

        <div id="status-view" class="card" hidden>
          <div class="flex space-between">
            <h3>פרטי פנייה <span id="sv-id" class="badge"></span></h3>
            <span id="sv-state" class="status"></span>
          </div>
          <p class="muted">נושא: <strong id="sv-subject"></strong> • מחלקה: <strong id="sv-dept"></strong> • נוצרה: <strong id="sv-created"></strong></p>
          <h4>ציר זמן</h4>
          <ol id="sv-timeline"></ol>
          <div class="grid cols-2">
            <div>
              <label for="sv-message">הוספת עדכון/שאלה לנציג</label>
              <textarea id="sv-message" placeholder="כתבו הודעה…"></textarea>
              <button class="btn" id="sv-send-msg" style="margin-top:8px">שליחת הודעה</button>
            </div>
            <div>
              <label for="sv-files">צרפו קבצים</label>
              <input id="sv-files" type="file" multiple />
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn ok" id="sv-ready-close">בקשת סגירה</button>
            <button class="btn bad" id="sv-reopen" hidden>פתיחה מחדש</button>
          </div>
        </div>
      </div>
    </section>

    <!-- מסך אדמין -->
    <section id="screen-admin" aria-labelledby="tab-admin">
      <div class="card grid">
        <h2>דשבורד אדמין</h2>
        <div class="grid cols-2">
          <div class="flex" style="gap:8px">
            <select id="f-dept" aria-label="סינון לפי מחלקה">
              <option value="">כל המחלקות</option>
            </select>
            <select id="f-state" aria-label="סינון לפי סטטוס">
              <option value="">כל המצבים</option>
              <option value="new">new</option>
              <option value="triaged">triaged</option>
              <option value="in_progress">in_progress</option>
              <option value="pending_citizen">pending_citizen</option>
              <option value="ready_for_close">ready_for_close</option>
              <option value="closed">closed</option>
              <option value="reopened">reopened</option>
            </select>
            <button class="btn" id="btn-export">ייצוא JSON</button>
          </div>
          <div class="flex space-between">
            <div class="badge warn">התראות SLA</div>
            <div id="slaCounters" class="muted">X:0 • Y:0 • Z:0</div>
          </div>
        </div>
        <div class="card">
          <table id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>נושא</th>
                <th>מחלקה</th>
                <th>נוצרה</th>
                <th>יעד SLA</th>
                <th>סטטוס</th>
                <th>פעולות</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" hidden>
    <div class="msg" role="status" aria-live="polite"></div>
  </div>

  <template id="tpl-row">
    <tr>
      <td class="col-id"></td>
      <td class="col-subject"></td>
      <td class="col-dept"></td>
      <td class="col-created"></td>
      <td class="col-sla"></td>
      <td class="col-status"></td>
      <td class="col-actions"></td>
    </tr>
  </template>

  <script>
    /********************
     * אחסון מקומי (MVP)
     ********************/
    const DB_KEY = 'citizen_tickets_v1';
    const state = {
      tickets: loadTickets(),
      departments: [
        { id: 'infra', name: 'תשתיות', sla: { firstResponseH: 48, resolveH: 168 } },
        { id: 'clean', name: 'ניקיון וסביבה', sla: { firstResponseH: 24, resolveH: 72 } },
        { id: 'traffic', name: 'תנועה וחניה', sla: { firstResponseH: 48, resolveH: 96 } },
        { id: 'education', name: 'חינוך', sla: { firstResponseH: 72, resolveH: 168 } },
        { id: 'welfare', name: 'רווחה וקהילה', sla: { firstResponseH: 72, resolveH: 168 } },
        { id: 'inspection', name: 'פיקוח עירוני', sla: { firstResponseH: 24, resolveH: 96 } },
        { id: 'tax', name: 'גבייה/ארנונה', sla: { firstResponseH: 72, resolveH: 168 } },
        { id: 'culture', name: 'תרבות ופנאי', sla: { firstResponseH: 72, resolveH: 168 } },
      ],
      slaThresholds: { X: 24, Y: 48, Z: 72 }, // שעות
    };

    function loadTickets(){
      try { return JSON.parse(localStorage.getItem(DB_KEY)) ?? []; } catch { return []; }
    }
    function saveTickets(){ localStorage.setItem(DB_KEY, JSON.stringify(state.tickets)); }

    /********************
     * עזרי תצוגה
     ********************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function toast(msg, ms=2200){
      const t = $('#toast'); t.querySelector('.msg').textContent = msg; t.hidden = false;
      setTimeout(()=>t.hidden=true, ms);
    }
    function fmtDate(d){ return new Date(d).toLocaleString('he-IL',{hour12:false}); }
    function byId(id){ return state.tickets.find(t=>t.id===id); }

    /********************
     * ניתוב אוטומטי (כללים)
     ********************/
    const ROUTING_RULES = [
      { dept:'infra', keywords:['בור','כביש','אספלט','מדרכה','תאורה','ניקוז'] },
      { dept:'clean', keywords:['גזם','אשפה','פינוי','מכולה','ריח','לכלוך'] },
      { dept:'traffic', keywords:['חניה','תמרור','רמזור','מהירות'] },
      { dept:'tax', keywords:['ארנונה','חיוב','חשבונית','תשלום','הנחה'] },
      { dept:'inspection', keywords:['רעש','כלב','חתול','עסק','היתר'] },
      { dept:'education', keywords:['בית ספר','כיתה','תלמיד','הסעות'] },
      { dept:'welfare', keywords:['סיוע','נגישות','רווחה'] },
      { dept:'culture', keywords:['אירוע','ספריה','מתנ"ס','ספורט'] },
    ];

    function classify(subject, description){
      const text = (subject + ' ' + description).toLowerCase();
      // חיפוש מילות מפתח פשוט (MVP). אפשר להחליף במודל NLU בהמשך.
      for(const rule of ROUTING_RULES){
        if(rule.keywords.some(k=> text.includes(k.toLowerCase()))) return rule.dept;
      }
      return 'infra'; // ברירת מחדל
    }

    function makeId(){
      const n = state.tickets.length + 1;
      return 'T-' + new Date().getFullYear() + '-' + String(n).padStart(6,'0');
    }

    /********************
     * שליחת הודעות (Mock)
     ********************/
    function sendEmail(to, subject, body){
      console.log('[EMAIL] →', to, subject, body);
    }
    function sendWhatsApp(to, template){
      console.log('[WHATSAPP] →', to, template);
    }

    /********************
     * טופס פתיחת פנייה
     ********************/
    const form = $('#form-intake');
    const fileInput = $('#files');
    fileInput.addEventListener('change', ()=>{
      const list = Array.from(fileInput.files).map(f=> `${f.name} • ${(f.size/1024/1024).toFixed(2)}MB`);
      $('#fileList').textContent = list.join(' | ');
    });

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!form.reportValidity()) { toast('יש להשלים שדות חובה'); return; }

      // גביית נתונים
      const data = Object.fromEntries(new FormData(form).entries());
      const deptId = classify(data.subject||'', data.description||'');
      const dept = state.departments.find(d=>d.id===deptId);
      const id = makeId();
      const now = new Date().toISOString();

      // אחסון קבצים: ב-MVP נשמור מטא-דאטה בלבד
      const attachments = Array.from(fileInput.files).slice(0,10).map(f=>({
        name:f.name, size:f.size, type:f.type
      }));

      const ticket = {
        id,
        citizen: {
          name: data.firstName + ' ' + data.lastName,
          phone: data.phone,
          email: data.email,
          address: data.address,
          consentEmail: !!data.consentEmail,
          consentWhatsApp: !!data.consentWhatsApp,
        },
        subject: data.subject,
        description: data.description,
        deptId,
        status: 'new',
        priority: 'normal',
        source: 'web',
        createdAt: now,
        updatedAt: now,
        attachments,
        messages: [
          {at:now, from:'system', body:'נוצרה פנייה והועברה למחלקה '+dept.name}
        ],
      };

      state.tickets.unshift(ticket);
      saveTickets();

      // אישור לתושב
      const subj = `קיבלנו את פנייה #${id}`;
      const body = `שלום ${ticket.citizen.name},\nקיבלנו את פנייתך בנושא "${ticket.subject}". מספר פנייה: ${id}.`;
      if(ticket.citizen.email && ticket.citizen.consentEmail) sendEmail(ticket.citizen.email, subj, body);
      if(ticket.citizen.phone && ticket.citizen.consentWhatsApp) sendWhatsApp(ticket.citizen.phone, 'OPEN_TICKET');

      // UI קבלה
      $('#ticketNumber').textContent = id;
      $('#ticketDept').textContent = dept.name;
      $('#receipt').hidden = false;
      toast('הפנייה נשלחה ונרשמה במערכת');
      form.reset();
      $('#fileList').textContent='';
    });

    $('#btnGoStatus').addEventListener('click', ()=> selectTab('status'));
    $('#btnNew').addEventListener('click', ()=> {
      $('#receipt').hidden = true;
      selectTab('intake');
    });

    /********************
     * ניווט בין מסכים
     ********************/
    $$('.tab').forEach(btn=> btn.addEventListener('click', ()=> selectTab(btn.dataset.screen)));
    function selectTab(screen){
      $$('.tab').forEach(b=> b.setAttribute('aria-selected', String(b.dataset.screen===screen)));
      $$('main section').forEach(s=> s.classList.toggle('active', s.id === 'screen-'+screen));
      location.hash = screen;
      if(screen==='admin') renderAdmin();
    }
    window.addEventListener('hashchange', ()=>{
      const t = location.hash.slice(1);
      if(['intake','status','admin'].includes(t)) selectTab(t);
    });
    if(location.hash) selectTab(location.hash.slice(1));

    /********************
     * סטטוס – צפייה ועדכונים
     ********************/
    const formStatus = $('#form-status');
    formStatus.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = $('#status-ticket-id').value.trim();
      const contact = $('#status-contact').value.trim();
      const t = byId(id);
      if(!t) return toast('לא נמצאה פנייה');
      if(!(t.citizen.email===contact || t.citizen.phone===contact)) return toast('אימות נכשל');
      showTicketStatus(t);
    });

    function showTicketStatus(t){
      $('#sv-id').textContent = t.id;
      $('#sv-state').textContent = t.status;
      $('#sv-state').className = 'status s-'+t.status;
      $('#sv-subject').textContent = t.subject;
      $('#sv-dept').textContent = state.departments.find(d=>d.id===t.deptId)?.name || t.deptId;
      $('#sv-created').textContent = fmtDate(t.createdAt);
      const tl = $('#sv-timeline'); tl.innerHTML='';
      t.messages.forEach(m=>{
        const li = document.createElement('li');
        li.textContent = `${fmtDate(m.at)} — ${m.from}: ${m.body}`;
        tl.appendChild(li);
      });
      $('#status-view').hidden = false;

      // כפתורי פעולה
      $('#sv-send-msg').onclick = ()=>{
        const body = $('#sv-message').value.trim();
        if(!body) return;
        t.messages.push({at:new Date().toISOString(), from:'citizen', body});
        t.status = 'pending_citizen'===t.status ? 'in_progress' : t.status; // דוגמה
        t.updatedAt = new Date().toISOString();
        saveTickets();
        showTicketStatus(t);
        toast('הודעה נשלחה');
      };
      $('#sv-ready-close').onclick = ()=>{
        t.status = 'ready_for_close';
        t.messages.push({at:new Date().toISOString(), from:'system', body:'בקשת סגירה נשלחה לתושב'});
        t.updatedAt = new Date().toISOString();
        saveTickets(); showTicketStatus(t); toast('סימון הפנייה כ\"מוכנה לסגירה\"');
      };
    }

    /********************
     * אדמין – טבלה ופעולות
     ********************/
    const selDept = $('#f-dept');
    state.departments.forEach(d=>{
      const o = document.createElement('option'); o.value=d.id; o.textContent=d.name; selDept.appendChild(o);
    });

    $('#btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state.tickets,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='tickets.json'; a.click(); URL.revokeObjectURL(url);
    });

    function renderAdmin(){
      // עדכון מוני SLA (דמוי X/Y/Z)
      const counters = {X:0,Y:0,Z:0};
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML='';

      const fDept = $('#f-dept').value;
      const fState = $('#f-state').value;

      state.tickets
        .filter(t=> !fDept || t.deptId===fDept)
        .filter(t=> !fState || t.status===fState)
        .forEach(t=>{
          const tr = document.importNode($('#tpl-row').content,true).firstElementChild;
          tr.querySelector('.col-id').textContent = t.id;
          tr.querySelector('.col-subject').textContent = t.subject;
          tr.querySelector('.col-dept').textContent = state.departments.find(d=>d.id===t.deptId)?.name || t.deptId;
          tr.querySelector('.col-created').textContent = fmtDate(t.createdAt);

          const dept = state.departments.find(d=>d.id===t.deptId);
          const created = new Date(t.createdAt);
          const due = new Date(created.getTime() + dept.sla.resolveH*3600*1000);
          tr.querySelector('.col-sla').textContent = fmtDate(due);

          const st = tr.querySelector('.col-status');
          st.textContent = t.status;
          st.className = 'col-status s-'+t.status;

          const actions = tr.querySelector('.col-actions');
          const btn1 = document.createElement('button'); btn1.className='btn'; btn1.textContent='ל\"בטיפול\"';
          btn1.onclick = ()=>{ t.status='in_progress'; bump(t,'עודכן ל\"בטיפול\"'); };
          const btn2 = document.createElement('button'); btn2.className='btn warn'; btn2.textContent='דרוש מידע';
          btn2.onclick = ()=>{ t.status='pending_citizen'; bump(t,'דרוש מידע מהתושב'); };
          const btn3 = document.createElement('button'); btn3.className='btn ok'; btn3.textContent='מוכן לסגירה';
          btn3.onclick = ()=>{ t.status='ready_for_close'; bump(t,'הטיפול הושלם – ממתין לאישור תושב'); };
          const btn4 = document.createElement('button'); btn4.className='btn bad'; btn4.textContent='סגור';
          btn4.onclick = ()=>{ t.status='closed'; bump(t,'הפנייה נסגרה'); };
          actions.append(btn1, btn2, btn3, btn4);

          // בדיקת SLA X/Y/Z – לפי זמן ללא עדכון
          const hoursSinceUpdate = (Date.now()-new Date(t.updatedAt).getTime())/3600000;
          if(hoursSinceUpdate > state.slaThresholds.Z) counters.Z++;
          else if(hoursSinceUpdate > state.slaThresholds.Y) counters.Y++;
          else if(hoursSinceUpdate > state.slaThresholds.X) counters.X++;

          tbody.appendChild(tr);
        });

      document.getElementById('slaCounters').textContent = `X:${counters.X} • Y:${counters.Y} • Z:${counters.Z}`;
    }

    selDept.addEventListener('change', renderAdmin);
    document.getElementById('f-state').addEventListener('change', renderAdmin);

    function bump(t, msg){
      t.updatedAt = new Date().toISOString();
      t.messages.push({at:t.updatedAt, from:'agent', body:msg});
      saveTickets(); renderAdmin(); toast('עודכן');
    }

    // רענון דשבורד אוטומטי כל 60ש׳ (באבטיפוס – כל 30ש׳)
    setInterval(()=>{ if(document.querySelector('section#screen-admin').classList.contains('active')) renderAdmin(); }, 30000);

    // מילוי ראשוני של הטבלה אם נכנסו ישירות
    if(location.hash.slice(1)==='admin') renderAdmin();
  </script>
</body>
</html>
